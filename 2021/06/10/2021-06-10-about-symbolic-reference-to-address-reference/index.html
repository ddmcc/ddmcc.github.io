<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>关于类解析阶段符号引用转为直接引用的过程 - ddmcc</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="ddmcc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="ddmcc"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="在 类加载过程 中介绍了 解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程，也就是得到类或者字段、方法在内存中的指针或者偏移量"><meta property="og:type" content="article"><meta property="og:title" content="关于类解析阶段符号引用转为直接引用的过程"><meta property="og:url" content="http://example.com/2021/06/10/2021-06-10-about-symbolic-reference-to-address-reference/"><meta property="og:site_name" content="ddmcc"><meta property="og:description" content="在 类加载过程 中介绍了 解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程，也就是得到类或者字段、方法在内存中的指针或者偏移量"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:published_time" content="2021-06-10T08:56:23.000Z"><meta property="article:modified_time" content="2023-04-14T19:13:11.632Z"><meta property="article:author" content="jiangrz"><meta property="article:tag" content="jvm"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2021/06/10/2021-06-10-about-symbolic-reference-to-address-reference/"},"headline":"关于类解析阶段符号引用转为直接引用的过程","image":["http://example.com/img/og_image.png"],"datePublished":"2021-06-10T08:56:23.000Z","dateModified":"2023-04-14T19:13:11.632Z","author":{"@type":"Person","name":"jiangrz"},"publisher":{"@type":"Organization","name":"ddmcc","logo":{"@type":"ImageObject","url":{"text":"jiangrz"}}},"description":"在 类加载过程 中介绍了 解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程，也就是得到类或者字段、方法在内存中的指针或者偏移量"}</script><link rel="canonical" href="http://example.com/2021/06/10/2021-06-10-about-symbolic-reference-to-address-reference/"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">jiangrz</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/ddmcc/ddmcc.github.io">GitHub</a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ddmcc/ddmcc.github.io"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-10T08:56:23.000Z" title="2021/6/10 16:56:23">2021-06-10</time>发表</span><span class="level-item"><time dateTime="2023-04-14T19:13:11.632Z" title="2023/4/15 03:13:11">2023-04-15</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/jvm/">jvm</a></span></div></div><h1 class="title is-3 is-size-4-mobile">关于类解析阶段符号引用转为直接引用的过程</h1><div class="content"><p>在 <a target="_blank" rel="noopener" href="http://ddmcc.cn/2021/05/29/jvm-class-file-loading-process/#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B">类加载过程</a> 中介绍了 <strong>解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程，也就是得到类或者字段、方法在内存中的指针或者偏移量</strong></p>
<span id="more"></span>

<p>那么什么是 <strong><code>符号引用</code></strong>? 什么又是 **<code>直接引用</code>**？二者之间又有什么关联？字段、方法在内存中又是如何存储和访问的？下面就通过 <code>class</code> 文件来具体分析</p>
<h2 id="符号引用"><a href="#符号引用" class="headerlink" title="符号引用"></a>符号引用</h2><p>有下面两个类<code>User</code> 和 <code>Address</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jiangrz</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> sex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printName</span><span class="params">()</span> &#123;</span><br><span class="line">        address.printAddress();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jiangrz</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Address</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String province;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printAddress</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<p>其中 <strong>User</strong> 类编译出来的 <code>class</code> 文件的文本形式如下：</p>
<hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Classfile</span> /<span class="title class_">Users</span>/jiangrz/workspace/other/demo/target/classes/com/example/demo/<span class="title class_">User</span>.<span class="property">class</span></span><br><span class="line">  <span class="title class_">Last</span> modified <span class="number">2021</span>年<span class="number">6</span>月<span class="number">14</span>日; size <span class="number">553</span> bytes</span><br><span class="line">  <span class="variable constant_">SHA</span>-<span class="number">256</span> checksum d9a9b9e80018881155b444972b9bcc32d83988780b8fbdf5e717ca49c1a5b944</span><br><span class="line">  <span class="title class_">Compiled</span> <span class="keyword">from</span> <span class="string">&quot;User.java&quot;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">com</span>.<span class="property">example</span>.<span class="property">demo</span>.<span class="property">User</span></span><br><span class="line">  minor <span class="attr">version</span>: <span class="number">0</span></span><br><span class="line">  major <span class="attr">version</span>: <span class="number">52</span></span><br><span class="line">  <span class="attr">flags</span>: (<span class="number">0x0021</span>) <span class="variable constant_">ACC_PUBLIC</span>, <span class="variable constant_">ACC_SUPER</span></span><br><span class="line">  <span class="attr">this_class</span>: #<span class="number">4</span>                          <span class="comment">// com/example/demo/User</span></span><br><span class="line">  <span class="attr">super_class</span>: #<span class="number">5</span>                         <span class="comment">// java/lang/Object</span></span><br><span class="line">  <span class="attr">interfaces</span>: <span class="number">0</span>, <span class="attr">fields</span>: <span class="number">4</span>, <span class="attr">methods</span>: <span class="number">2</span>, <span class="attr">attributes</span>: <span class="number">1</span></span><br><span class="line"><span class="title class_">Constant</span> <span class="attr">pool</span>:</span><br><span class="line">   #<span class="number">1</span> = <span class="title class_">Methodref</span>          #<span class="number">5.</span>#<span class="number">24</span>         <span class="comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   #<span class="number">2</span> = <span class="title class_">Fieldref</span>           #<span class="number">4.</span>#<span class="number">25</span>         <span class="comment">// com/example/demo/User.address:Lcom/example/demo/Address;</span></span><br><span class="line">   #<span class="number">3</span> = <span class="title class_">Methodref</span>          #<span class="number">26.</span>#<span class="number">27</span>        <span class="comment">// com/example/demo/Address.printAddress:()V</span></span><br><span class="line">   #<span class="number">4</span> = <span class="title class_">Class</span>              #<span class="number">28</span>            <span class="comment">// com/example/demo/User</span></span><br><span class="line">   #<span class="number">5</span> = <span class="title class_">Class</span>              #<span class="number">29</span>            <span class="comment">// java/lang/Object</span></span><br><span class="line">   #<span class="number">6</span> = <span class="title class_">Utf8</span>               sex</span><br><span class="line">   #<span class="number">7</span> = <span class="title class_">Utf8</span>               Z</span><br><span class="line">   #<span class="number">8</span> = <span class="title class_">Utf8</span>               name</span><br><span class="line">   #<span class="number">9</span> = <span class="title class_">Utf8</span>               <span class="title class_">Ljava</span>/lang/<span class="title class_">String</span>;</span><br><span class="line">  #<span class="number">10</span> = <span class="title class_">Utf8</span>               age</span><br><span class="line">  #<span class="number">11</span> = <span class="title class_">Utf8</span>               <span class="title class_">Ljava</span>/lang/<span class="title class_">Integer</span>;</span><br><span class="line">  #<span class="number">12</span> = <span class="title class_">Utf8</span>               address</span><br><span class="line">  #<span class="number">13</span> = <span class="title class_">Utf8</span>               <span class="title class_">Lcom</span>/example/demo/<span class="title class_">Address</span>;</span><br><span class="line">  #<span class="number">14</span> = <span class="title class_">Utf8</span>               &lt;init&gt;</span><br><span class="line">  #<span class="number">15</span> = <span class="title class_">Utf8</span>               ()V</span><br><span class="line">  #<span class="number">16</span> = <span class="title class_">Utf8</span>               <span class="title class_">Code</span></span><br><span class="line">  #<span class="number">17</span> = <span class="title class_">Utf8</span>               <span class="title class_">LineNumberTable</span></span><br><span class="line">  #<span class="number">18</span> = <span class="title class_">Utf8</span>               <span class="title class_">LocalVariableTable</span></span><br><span class="line">  #<span class="number">19</span> = <span class="title class_">Utf8</span>               <span class="variable language_">this</span></span><br><span class="line">  #<span class="number">20</span> = <span class="title class_">Utf8</span>               <span class="title class_">Lcom</span>/example/demo/<span class="title class_">User</span>;</span><br><span class="line">  #<span class="number">21</span> = <span class="title class_">Utf8</span>               printName</span><br><span class="line">  #<span class="number">22</span> = <span class="title class_">Utf8</span>               <span class="title class_">SourceFile</span></span><br><span class="line">  #<span class="number">23</span> = <span class="title class_">Utf8</span>               <span class="title class_">User</span>.<span class="property">java</span></span><br><span class="line">  #<span class="number">24</span> = <span class="title class_">NameAndType</span>        #<span class="number">14</span>:#<span class="number">15</span>        <span class="comment">// &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  #<span class="number">25</span> = <span class="title class_">NameAndType</span>        #<span class="number">12</span>:#<span class="number">13</span>        <span class="comment">// address:Lcom/example/demo/Address;</span></span><br><span class="line">  #<span class="number">26</span> = <span class="title class_">Class</span>              #<span class="number">30</span>            <span class="comment">// com/example/demo/Address</span></span><br><span class="line">  #<span class="number">27</span> = <span class="title class_">NameAndType</span>        #<span class="number">31</span>:#<span class="number">15</span>        <span class="comment">// printAddress:()V</span></span><br><span class="line">  #<span class="number">28</span> = <span class="title class_">Utf8</span>               com/example/demo/<span class="title class_">User</span></span><br><span class="line">  #<span class="number">29</span> = <span class="title class_">Utf8</span>               java/lang/<span class="title class_">Object</span></span><br><span class="line">  #<span class="number">30</span> = <span class="title class_">Utf8</span>               com/example/demo/<span class="title class_">Address</span></span><br><span class="line">  #<span class="number">31</span> = <span class="title class_">Utf8</span>               printAddress</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> com.<span class="property">example</span>.<span class="property">demo</span>.<span class="title class_">User</span>();</span><br><span class="line">    <span class="attr">descriptor</span>: ()V</span><br><span class="line">    <span class="attr">flags</span>: (<span class="number">0x0001</span>) <span class="variable constant_">ACC_PUBLIC</span></span><br><span class="line">    <span class="title class_">Code</span>:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: invokespecial #<span class="number">1</span>                  <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">      <span class="title class_">LineNumberTable</span>:</span><br><span class="line">        line <span class="number">6</span>: <span class="number">0</span></span><br><span class="line">      <span class="title class_">LocalVariableTable</span>:</span><br><span class="line">        <span class="title class_">Start</span>  <span class="title class_">Length</span>  <span class="title class_">Slot</span>  <span class="title class_">Name</span>   <span class="title class_">Signature</span></span><br><span class="line">            <span class="number">0</span>       <span class="number">5</span>     <span class="number">0</span>  <span class="variable language_">this</span>   <span class="title class_">Lcom</span>/example/demo/<span class="title class_">User</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">printName</span>();</span><br><span class="line">    <span class="attr">descriptor</span>: ()V</span><br><span class="line">    <span class="attr">flags</span>: (<span class="number">0x0001</span>) <span class="variable constant_">ACC_PUBLIC</span></span><br><span class="line">    <span class="title class_">Code</span>:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: getfield      #<span class="number">2</span>                  <span class="comment">// Field address:Lcom/example/demo/Address;</span></span><br><span class="line">         <span class="number">4</span>: invokevirtual #<span class="number">3</span>                  <span class="comment">// Method com/example/demo/Address.printAddress:()V</span></span><br><span class="line">         <span class="number">7</span>: <span class="keyword">return</span></span><br><span class="line">      <span class="title class_">LineNumberTable</span>:</span><br><span class="line">        line <span class="number">19</span>: <span class="number">0</span></span><br><span class="line">        line <span class="number">20</span>: <span class="number">7</span></span><br><span class="line">      <span class="title class_">LocalVariableTable</span>:</span><br><span class="line">        <span class="title class_">Start</span>  <span class="title class_">Length</span>  <span class="title class_">Slot</span>  <span class="title class_">Name</span>   <span class="title class_">Signature</span></span><br><span class="line">            <span class="number">0</span>       <span class="number">8</span>     <span class="number">0</span>  <span class="variable language_">this</span>   <span class="title class_">Lcom</span>/example/demo/<span class="title class_">User</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<p>在 class 文件中有一段 <strong>Constant pool</strong>  信息，里面存储的该Class文件里的大部分常量的内容，如：类和接口的全限定名、字段的名称和描述符以及方法的名称和描述符</p>
<p>看到 <strong>printName()</strong> 方法有一条字节码指令：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: getfield      #<span class="number">2</span>                  <span class="comment">// Field address:Lcom/example/demo/Address;</span></span><br></pre></td></tr></table></figure>



<p>其中 <strong>#2</strong> 代表在常量池中的下标，在常量池中找到下标为2的信息：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">2</span> = <span class="title class_">Fieldref</span>           #<span class="number">4.</span>#<span class="number">25</span>         <span class="comment">// com/example/demo/User.address:Lcom/example/demo/Address;</span></span><br></pre></td></tr></table></figure>



<p><strong>Fieldref</strong> 是字段的结构表示，具体查看 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4.2">虚拟机规范4.4.2</a> ，后面的 <strong>#4.#25</strong> 分别表示 <code>class_index</code> 和 <code>name_and_type_index</code> ，这两个都是常量池下标（即所在类结构在常量池的下标和字段名与字段类型在常量池的下标），引用着另外两个常量池项。顺着这个方法把所有引用的常量都找出来，可以得到：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> #<span class="number">2</span> = <span class="title class_">Fieldref</span>           #<span class="number">4.</span>#<span class="number">25</span>         <span class="comment">// com/example/demo/User.address:Lcom/example/demo/Address;</span></span><br><span class="line"> #<span class="number">4</span> = <span class="title class_">Class</span>              #<span class="number">28</span>            <span class="comment">// com/example/demo/User</span></span><br><span class="line">#<span class="number">28</span> = <span class="title class_">Utf8</span>               com/example/demo/<span class="title class_">User</span></span><br><span class="line">#<span class="number">25</span> = <span class="title class_">NameAndType</span>        #<span class="number">12</span>:#<span class="number">13</span>        <span class="comment">// address:Lcom/example/demo/Address;</span></span><br><span class="line">#<span class="number">12</span> = <span class="title class_">Utf8</span>               address</span><br><span class="line">#<span class="number">13</span> = <span class="title class_">Utf8</span>               <span class="title class_">Lcom</span>/example/demo/<span class="title class_">Address</span>;</span><br></pre></td></tr></table></figure>



<p>上面的常量池项对应文件结构表示为：</p>
<ul>
<li>Class：<code>CONSTANT_Class_info</code></li>
<li>Utf8：<code>CONSTANT_Utf8_info</code></li>
<li>NameAndType：<code>CONSTANT_NameAndType_info</code></li>
</ul>
<p><strong>标记为 Utf8 的常量池项在 class 文件中实际为 CONSTANT_Utf8_info，是以 UTF-8 编码的字符串文本</strong> ，比如 <code>#12 = Utf8</code> 实际值为 <code>address</code></p>
<p>这就是<code>class</code> 文件里的 <strong>符号引用</strong> 实际存储的值：带有类型（tag） /  结构（符号间引用层次）的字符串。将上面的引用关系画成树：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">                #2：Fieldref   #4.#25</span><br><span class="line">                /                   \</span><br><span class="line">           #4：Class #28         #25：NameAndType #12:#13</span><br><span class="line">           /                            /              \</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">28：Utf8 com/example/demo/User    <span class="comment">#12：Utf8 address   #13：Utf8 Lcom/example/demo/Address;</span></span></span><br></pre></td></tr></table></figure>





<p>上面是字段的符号引用表示，我们再来看一个方法的符号引用表示，还是在 <strong>printName()</strong> 方法：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>: invokevirtual #<span class="number">3</span>                  <span class="comment">// Method com/example/demo/Address.printAddress:()V</span></span><br></pre></td></tr></table></figure>



<p>和上面相同，这个虚拟机指令是调用 <code>Address</code> 类的 <code>printAddress</code> 方法。找到常量池中下标为 <strong>#3</strong> 的项：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">3</span> = <span class="title class_">Methodref</span>          #<span class="number">26.</span>#<span class="number">27</span>        <span class="comment">// com/example/demo/Address.printAddress:()V</span></span><br></pre></td></tr></table></figure>



<p><code>Methodref</code>  和 <code>Fieldref</code> 的结构相同，由 1 个字节的 tag / 2 个字节 class_index / 2 个字节的 name_and_type_index 组成：</p>
<blockquote>
<p>u1 为1个字节，u2为两个字节  <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html">The class File Format</a></p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Fieldref_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u2 class_index;</span><br><span class="line">    u2 name_and_type_index;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CONSTANT_Methodref_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u2 class_index;</span><br><span class="line">    u2 name_and_type_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>所以可以知道 <strong>#26</strong> 为类符号结构的下标，**#27** 则是方法名和返回值的结构下标。根据上面的方法得到引用关系：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> #<span class="number">3</span> = <span class="title class_">Methodref</span>          #<span class="number">26.</span>#<span class="number">27</span>        <span class="comment">// com/example/demo/Address.printAddress:()V</span></span><br><span class="line">#<span class="number">26</span> = <span class="title class_">Class</span>              #<span class="number">30</span>            <span class="comment">// com/example/demo/Address</span></span><br><span class="line">#<span class="number">30</span> = <span class="title class_">Utf8</span>               com/example/demo/<span class="title class_">Address</span></span><br><span class="line">#<span class="number">27</span> = <span class="title class_">NameAndType</span>        #<span class="number">31</span>:#<span class="number">15</span>        <span class="comment">// printAddress:()V</span></span><br><span class="line">#<span class="number">31</span> = <span class="title class_">Utf8</span>               printAddress</span><br><span class="line">#<span class="number">15</span> = <span class="title class_">Utf8</span>               ()V    <span class="comment">// 这是方法返回值的符号引用</span></span><br></pre></td></tr></table></figure>





<p><strong>由此可以看出，Class文件中的invokevirtual指令的操作数经过几层引用之后，最后都是由字符串来表示的</strong></p>
<h2 id="直接引用"><a href="#直接引用" class="headerlink" title="直接引用"></a>直接引用</h2><p>上面都是说的 <code>“符号引用”</code>，下面在看看直接引用：</p>
<p>大致是在类加载的时候会把 <code>Class</code> 文件的各个部分分别解析（parse）为 JVM 的内部数据结构。例如说类的元数据记录在 <code>Class</code> 结构体里，每个方法的元数据记录在各自的 <code>methodblock</code> 结构体里等等</p>
<p>在刚加载好一个类的时候，<code>Class</code> 文件里的常量池和每个方法的字节码（Code属性）会被基本原样的拷贝到内存里先放着，也就是说仍然处于使用 “符号引用” 的状态，直到真的要被使用到的时候才会被解析（resolve）为直接引用</p>
<p>假定我们要第一次执行到 <strong>printName()</strong> 方法里调用 <strong>printAddress()</strong> 方法的那条invokevirtual指令了，此时 JVM 会发现该指令尚未被解析（resolve），所以会先去解析一下。通过其操作数所记录的常量池下标找到常量池项 <strong>#3</strong>，发现该常量池项也尚未被解析（resolve），于是进一步去解析一下。通过 <code>Methodref</code> 所记录的 <code>class_index</code> 找到类名，进一步找到被调用方法的类的 <code>Class</code> 结构体，然后通过<code>name_and_type_index</code> 找到方法名和方法返回类型，到找到的 <code>Class</code> 结构体上记录的方法列表里找到匹配的那个 <code>methodblock</code>，最终把找到的 <code>methodblock</code> 的指针写回到常量池项 <strong>#3</strong> 里</p>
<p><strong>也就是说，原本常量池项 #3 在类加载后的运行时常量池里的内容跟Class文件里的一致，只是解析后它的内容变了，由原来的字符串表示的 “符号引用” 变为一个能直接找到 Java 方法元数据的 methodblock 了。这里的 methodblock 就是一个  “直接引用”</strong>，**#3** 常量项保存着 <code>methodblock</code> 直接指针</p>
<p>解析好常量池项 <strong>#3</strong> 之后回到 <code>invokevirtual</code> 指令的解析，在解析后虚拟机指令从 <code>invokevirtual</code> 改写为 <code>invokevirtual_quick</code>表示该指令已经解析完毕。原本存储操作数的 <strong>2</strong> 字节空间现在分别存了 <strong>2个1</strong> 字节信息，第一个是 <strong>虚方法表的下标（vtable index）</strong>，第二个是 <strong>方法的参数个数（args_size）</strong>。这两项信息都由前面解析常量池项 <strong>#3</strong> 得到的 methodblock 读取而来</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invokevirtual_quick vtable_index=<span class="number">5</span>, args_size=<span class="number">1</span></span><br></pre></td></tr></table></figure>



<p>在 <code>Address</code> 类的虚方法表就会有：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">hashCode</span>:()I</span><br><span class="line">[<span class="number">1</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">equals</span>:(<span class="title class_">Ljava</span>/lang/<span class="title class_">Object</span>;)Z</span><br><span class="line">[<span class="number">2</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">clone</span>:()<span class="title class_">Ljava</span>/lang/<span class="title class_">Object</span>;</span><br><span class="line">[<span class="number">3</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">toString</span>:()<span class="title class_">Ljava</span>/lang/<span class="title class_">String</span>;</span><br><span class="line">[<span class="number">4</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">finalize</span>:()V</span><br><span class="line">[<span class="number">5</span>]: com.<span class="property">example</span>.<span class="property">demo</span>.<span class="property">Address</span>.<span class="property">printAddress</span>:()V</span><br></pre></td></tr></table></figure>



<p><code>User</code> 类的虚方法表则：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">hashCode</span>:()I</span><br><span class="line">[<span class="number">1</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">equals</span>:(<span class="title class_">Ljava</span>/lang/<span class="title class_">Object</span>;)Z</span><br><span class="line">[<span class="number">2</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">clone</span>:()<span class="title class_">Ljava</span>/lang/<span class="title class_">Object</span>;</span><br><span class="line">[<span class="number">3</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">toString</span>:()<span class="title class_">Ljava</span>/lang/<span class="title class_">String</span>;</span><br><span class="line">[<span class="number">4</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">finalize</span>:()V</span><br><span class="line">[<span class="number">5</span>]: com.<span class="property">example</span>.<span class="property">demo</span>.<span class="property">User</span>.<span class="property">printName</span>:()V</span><br></pre></td></tr></table></figure>



<p>在执行 <code>invokevirtual_quick</code> 调用 <strong>printAddress()</strong> 时，通过对象引用查找到虚方法表后，从中取出第 <strong>#5</strong> 项的<code>methodblock</code>，就可以找到实际应该调用的目标然后调用过去了</p>
<p><strong>直接引用是运行时所能直接使用的形式，即可以表现为直接指针（如上面#3常量项解析为 methodblock），也可能是其它形式（如invokevirtual_quick 指令里的vtable的下标），关键点不在于是否为直接指针或其它偏移量，在于jvm能不能直接使用</strong></p>
<h2 id="jvm中多态的实现"><a href="#jvm中多态的实现" class="headerlink" title="jvm中多态的实现"></a>jvm中多态的实现</h2><p>假如有一个类 <code>Staff</code> 继承了类 <code>User</code> ，并重写了 <code>printName()方法</code> ，那么类 Staff 的虚方法表就会有：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">hashCode</span>:()I</span><br><span class="line">[<span class="number">1</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">equals</span>:(<span class="title class_">Ljava</span>/lang/<span class="title class_">Object</span>;)Z</span><br><span class="line">[<span class="number">2</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">clone</span>:()<span class="title class_">Ljava</span>/lang/<span class="title class_">Object</span>;</span><br><span class="line">[<span class="number">3</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">toString</span>:()<span class="title class_">Ljava</span>/lang/<span class="title class_">String</span>;</span><br><span class="line">[<span class="number">4</span>]: java.<span class="property">lang</span>.<span class="property">Object</span>.<span class="property">finalize</span>:()V</span><br><span class="line">[<span class="number">5</span>]: com.<span class="property">example</span>.<span class="property">demo</span>.<span class="property">User</span>.<span class="property">otherMethod</span>:()V    <span class="comment">// 继承而来的方法</span></span><br><span class="line">[<span class="number">5</span>]: com.<span class="property">example</span>.<span class="property">demo</span>.<span class="property">Staff</span>.<span class="property">printName</span>:()V   <span class="comment">// 重写了父类的方法</span></span><br><span class="line">[<span class="number">6</span>]: com.<span class="property">example</span>.<span class="property">demo</span>.<span class="property">Staff</span>.<span class="property">printStaff</span>:()V  <span class="comment">// 子类自己的方法</span></span><br></pre></td></tr></table></figure>



<p>虚方法表中方法存放顺序是先父类-再子类的顺序，所有的类都继承自 Object 类，所以表中 <strong>最先存放的是Object类的方法</strong>，接下来是该类的父类 <strong>User</strong> 的方法，最后是该类本身的方法。当调用的时候通过传入的实际指向this来确定方法的接收者（receiver），动态绑定（分派）具体对象的类型（因为是多态，所以指向的是子类对象的类型），继而找到方法区里子类的方法表，根据偏移量找到子类方法表对应的方法</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/30300585">JVM里的符号引用如何存储？</a></p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/jvm/">jvm</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/07/10/2021-07-10-use-wx-and-oss-create-image-hosting-website/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">利用微信公众号+腾讯云cos制作图床</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/05/29/2021-05-29-jvm-class-file-loading-process/"><span class="level-item">Java虚拟机类加载过程与类加载机制</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "1b21224c2a4733dec41ec273722c800e",
            repo: "ddmcc.github.io",
            owner: "ddmcc",
            clientID: "dae41ffb8c8e11287ad0",
            clientSecret: "2e2acba40e8060cbac419bae13b068ab92a539ab",
            admin: ["ddmcc"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#符号引用"><span class="level-left"><span class="level-item">1</span><span class="level-item">符号引用</span></span></a></li><li><a class="level is-mobile" href="#直接引用"><span class="level-left"><span class="level-item">2</span><span class="level-item">直接引用</span></span></a></li><li><a class="level is-mobile" href="#jvm中多态的实现"><span class="level-left"><span class="level-item">3</span><span class="level-item">jvm中多态的实现</span></span></a></li><li><a class="level is-mobile" href="#参考"><span class="level-left"><span class="level-item">4</span><span class="level-item">参考</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-06T07:34:00.000Z">2023-07-06</time></p><p class="title"><a href="/2023/07/06/2023-07-06-feign-integrates-ribbon/">feign基于ribbon实现负载均衡</a></p><p class="categories"><a href="/categories/Spring-Cloud/">Spring Cloud</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-29T07:34:00.000Z">2023-05-29</time></p><p class="title"><a href="/2023/05/29/2023-05-29-ribbon-components-and-integration-of-gateway/">openFeign整合ribbon实现负载均衡</a></p><p class="categories"><a href="/categories/Spring-Cloud/">Spring Cloud</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-29T07:34:00.000Z">2023-05-29</time></p><p class="title"><a href="/2023/05/29/2023-05-29-websocket-clusters/">websocket服务集群搭建与消息收发实现</a></p><p class="categories"><a href="/categories/websocket/">websocket</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-13T07:34:00.000Z">2023-04-13</time></p><p class="title"><a href="/2023/04/13/2023-04-13-how-feign-works/">OpenFeign的实现原理</a></p><p class="categories"><a href="/categories/Spring-Cloud/">Spring Cloud</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-01T07:34:00.000Z">2023-04-01</time></p><p class="title"><a href="/2023/04/01/2023-04-01-composite-pattern/">设计模式之组合模式</a></p><p class="categories"><a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">jiangrz</a><p class="is-size-7"><span>&copy; 2024 jiangrz</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent " target="_blank" rel="noopener" title="备案号：闽ICP备2023008580号-1" href="https://beian.miit.gov.cn">备案号：闽ICP备2023008580号-1</a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>